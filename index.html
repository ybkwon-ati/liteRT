<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LiteRT 실시간 전사</title>
    <link rel="stylesheet" href="styles.css?v=3.0.0">
</head>
<body>
    <div class="container">
        <header>
            <h1>🎤 LiteRT 실시간 전사</h1>
            <p class="subtitle">음성을 실시간으로 텍스트로 변환합니다</p>
        </header>

        <main>
            <div class="control-panel">
                <button id="startBtn" class="btn btn-primary">
                    <span class="btn-icon">▶</span>
                    전사 시작
                </button>
                <button id="stopBtn" class="btn btn-secondary" disabled>
                    <span class="btn-icon">⏹</span>
                    전사 중지
                </button>
                <button id="clearBtn" class="btn btn-danger">
                    <span class="btn-icon">🗑</span>
                    기록 지우기
                </button>
                <button id="modelConfigBtn" class="btn btn-info" style="display: inline-flex !important; visibility: visible !important;">
                    <span class="btn-icon">🤖</span>
                    모델 설정
                </button>
            </div>

            <div class="status-bar">
                <span id="status" class="status">대기 중...</span>
                <span id="language" class="language">언어: 한국어</span>
            </div>

            <div class="model-config-section">
                <div class="model-config-header">
                    <h3>🤖 AI 모델 설정</h3>
                </div>
                <div id="currentModel" class="current-model">
                    현재 모델: <span id="currentModelName">로딩 중...</span>
                </div>
            </div>

            <div id="modelConfigModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>AI 모델 설정</h2>
                        <button id="closeModal" class="btn-close-modal">✕</button>
                    </div>
                    <div class="modal-body">
                        <div class="model-source-tabs">
                            <button class="tab-btn active" data-tab="gallery">Edge Gallery</button>
                            <button class="tab-btn" data-tab="custom">직접 입력</button>
                            <button class="tab-btn" data-tab="downloaded">다운로드된 모델</button>
                        </div>

                        <div id="galleryTab" class="tab-content active">
                            <div class="model-search">
                                <input type="text" id="modelSearch" placeholder="모델 검색..." class="search-input">
                                <button id="searchBtn" class="btn-search">검색</button>
                            </div>
                            <div class="model-list-container">
                                <div id="modelList" class="model-list">
                                    <div class="loading-models">모델 목록 로딩 중...</div>
                                </div>
                            </div>
                        </div>

                        <div id="customTab" class="tab-content">
                            <div class="custom-model-input">
                                <label for="customModelId">모델 ID 입력:</label>
                                <input type="text" id="customModelId" placeholder="예: TinyLlama-1.1B-Chat-v0.4" class="model-input">
                                <p class="model-hint">WebLLM에서 지원하는 모델 ID를 입력하세요</p>
                            </div>
                            <div class="preset-models">
                                <h4>추천 모델:</h4>
                                <div class="preset-list">
                                    <button class="preset-btn" data-model="TinyLlama-1.1B-Chat-v0.4">TinyLlama-1.1B-Chat-v0.4 (경량)</button>
                                    <button class="preset-btn" data-model="Llama-3.2-3B-Instruct-q4f32_1">Llama-3.2-3B-Instruct (중형)</button>
                                    <button class="preset-btn" data-model="Phi-3-mini-4k-instruct-q4f32_1">Phi-3-mini-4k-instruct (경량)</button>
                                    <button class="preset-btn" data-model="Qwen2.5-0.5B-Instruct-q4f32_1">Qwen2.5-0.5B-Instruct (초경량)</button>
                                </div>
                            </div>
                        </div>

                        <div id="downloadedTab" class="tab-content">
                            <div class="downloaded-models-header">
                                <h4>다운로드된 모델 목록</h4>
                                <button id="refreshDownloadedBtn" class="btn-refresh">🔄 새로고침</button>
                            </div>
                            <div class="model-list-container">
                                <div id="downloadedModelList" class="model-list">
                                    <div class="loading-models">다운로드된 모델 확인 중...</div>
                                </div>
                            </div>
                            <p class="model-hint" style="margin-top: 15px;">
                                💡 모델은 브라우저의 IndexedDB에 저장됩니다. 모델 삭제는 브라우저 개발자 도구에서 IndexedDB를 직접 삭제해야 합니다.
                            </p>
                        </div>

                        <div class="model-loading-status" id="modelLoadingStatus" style="display: none;">
                            <div class="loading-progress">
                                <div class="progress-bar">
                                    <div id="modelProgress" class="progress-fill"></div>
                                </div>
                                <span id="modelProgressText">0%</span>
                            </div>
                            <p id="modelStatusText">모델 다운로드 중...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="loadModelBtn" class="btn-load-model" disabled>모델 로드</button>
                        <button id="cancelModelBtn" class="btn-cancel">취소</button>
                    </div>
                </div>
            </div>

            <div class="mic-level-container">
                <div class="mic-level-label">마이크 레벨</div>
                <div class="mic-level-bar">
                    <div id="micLevel" class="mic-level-fill"></div>
                </div>
                <span id="micLevelText" class="mic-level-text">0%</span>
            </div>

            <div class="transcription-area">
                <div class="transcription-header">
                    <h3>전사 결과</h3>
                    <div class="ai-actions">
                        <button id="translateBtn" class="btn-ai" title="번역">
                            🌐 번역
                        </button>
                        <button id="summarizeBtn" class="btn-ai" title="요약">
                            📝 요약
                        </button>
                    </div>
                </div>
                <div id="transcription" class="transcription-text">
                    전사 결과가 여기에 표시됩니다...
                </div>
            </div>

            <div id="aiResultSection" class="ai-result-section" style="display: none;">
                <div class="ai-result-header">
                    <h3 id="aiResultTitle">AI 처리 결과</h3>
                    <button id="closeAiResult" class="btn-close">✕</button>
                </div>
                <div id="aiResult" class="ai-result-content"></div>
            </div>

            <div class="history-section">
                <div class="history-header">
                    <h2>📝 전사 기록 관리</h2>
                    <button id="historyManageBtn" class="btn-history-manage">📅 기록 관리</button>
                </div>
                <div id="history" class="history-list"></div>
            </div>

            <!-- 기록 관리 모달 -->
            <div id="historyManageModal" class="modal" style="display: none;">
                <div class="modal-content history-modal-content">
                    <div class="modal-header">
                        <h2>전사 기록 관리</h2>
                        <button id="closeHistoryModal" class="btn-close-modal">✕</button>
                    </div>
                    <div class="modal-body">
                        <!-- 검색 및 필터 -->
                        <div class="history-filters">
                            <div class="search-box">
                                <input type="text" id="historySearch" placeholder="기록 내용 검색..." class="search-input">
                                <button id="historySearchBtn" class="btn-search">🔍 검색</button>
                            </div>
                            <div class="date-filters">
                                <div class="date-filter-item">
                                    <label>날짜 선택:</label>
                                    <input type="date" id="historyDateFilter" class="date-input">
                                    <button id="clearDateFilter" class="btn-clear-filter">초기화</button>
                                </div>
                                <div class="date-filter-item">
                                    <label>기간 선택:</label>
                                    <input type="date" id="historyStartDate" class="date-input">
                                    <span>~</span>
                                    <input type="date" id="historyEndDate" class="date-input">
                                    <button id="applyDateRange" class="btn-apply-filter">적용</button>
                                </div>
                            </div>
                        </div>

                        <!-- 달력 뷰 -->
                        <div class="calendar-view">
                            <div class="calendar-header">
                                <button id="prevMonth" class="btn-calendar-nav">◀</button>
                                <h3 id="currentMonthYear"></h3>
                                <button id="nextMonth" class="btn-calendar-nav">▶</button>
                            </div>
                            <div id="calendar" class="calendar-grid"></div>
                        </div>

                        <!-- 기록 목록 -->
                        <div class="history-list-section">
                            <h4>기록 목록</h4>
                            <div id="historyManageList" class="history-manage-list">
                                <div class="loading-models">기록을 불러오는 중...</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="closeHistoryManageBtn" class="btn-cancel">닫기</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>LiteRT.js 기반 실시간 전사 애플리케이션</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/litert@latest/dist/litert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@latest/dist/index.js" 
            onload="window.webllmLoaded = true; console.log('WebLLM loaded');"
            onerror="console.error('WebLLM failed to load');"></script>
    <script>
        // 강력한 캐시 버스팅 - 타임스탬프 사용
        (function() {
            const timestamp = new Date().getTime();
            const script = document.createElement('script');
            script.src = `app.js?t=${timestamp}&v=3.0.0`;
            script.type = 'text/javascript';
            script.async = false;
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>

